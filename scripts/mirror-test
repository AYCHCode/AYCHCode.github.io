#!/usr/local/bin/php -q
<?php # vim: ft=php

/*
 Ping each mirror, get what state they are in, and
 store in the local database. This data is used to
 automatically deactivate mirrors if needed. The
 gathered information is also mailed to the php-mirrors
 mailing list periodically by the mirror-summary
 script.
*/

set_error_handler("myhandler");

// This script will run for a long time
set_time_limit (0);

// DEBUG
sendmessage("Mirror site check started");

// Connect to local MySQL database
mysql_connect("localhost","nobody","")
    or sendmessage("unable to connect to database", TRUE);
mysql_select_db("php3");

// Get mirror information for all active mirrors (regardless of their type!)
$query = "SELECT maintainer, hostname, id, has_search FROM mirrors WHERE active = 1";
$result = mysql_query($query)
    or sendmessage("unable to get from the database: " . mysql_error(), TRUE);

// Get all mirror site data to the $hosts array
$hosts = array();
while ($row = mysql_fetch_array($result)) {
    $hosts[] = $row;
}

// DEBUG
sendmessage("Database data now in a PHP array");

// Get all mirror sites, and count the index of them
foreach ($hosts as $index => $host) {

    // Open port 80 on the mirror site
    $fp = @fsockopen($host['hostname'], 80, $errno, $errstr, 15);
    
    // If we were unable to open the port, continue with the next mirror
    if (!$fp) {
        if ($test_debug) { echo "unable to connect to $host[hostname]\n"; flush(); }
        continue;
    }

    // GET mirror-info.php from the registered hostname
    $rc = fputs($fp, "GET /mirror-info.php HTTP/1.0\r\nHost: $host[hostname]\r\n\r\n");
    
    // If we were unable to write to socket, skip mirror site
    if ($rc === FALSE) {
        if ($test_debug) { echo "unable to send request to $host[hostname]\n"; flush(); }
        continue;
    }
    
    // Set timeout to 5 seconds
    socket_set_timeout($fp, 5, 0);

    // Get lines from the socket, while we get past the HTTP headers
    // (HTTP headers and data have one empty line between them)
    do {
        $line = fgets($fp);
    } while ($line !== FALSE && $line != "" && $line != "\r\n" && $line != "\n");

    // If we were unable to pass the HTTP header, skip mirror site
    if ($line === FALSE || $line == "") {
        if ($test_debug) { echo "didn't get past headers for $host[hostname]\n"; flush(); }
        continue;
    }
        
    // Get data row from socket
    $rv = fgets($fp);

    // If unable to read that row, skip mirror site
    if ($rv === FALSE) {
        if ($test_debug) { echo "didn't get data for $host[hostname]\n"; flush(); }
        continue;
    } else {
        if ($test_debug) { echo "received data from $host[hostname]\n"; flush(); }
    }
    
    // Exlode information row by delimiter
    $info = explode("|", $rv);
    
    // Put pieces into the $hosts array
    $hosts[$index]['phpversion'] = $info[1];
    
    // The last updated date is a number [db security]
    if (is_numeric($info[2])) {
        $hosts[$index]['mirrorupdated'] = $info[2];
    }
    
    // If new search information is available, override previous one
    if (in_array($info[3], array('0', '1', '2'))) {
        $hosts[$index]['has_search'] = $info[3];
    }
}

// DEBUG
sendmessage("All mirrors checked");

// Go through all mirror sites checked
$mirrorsupdated = 0;
foreach ($hosts as $host) {
    
    // If "mirrorupdated" date specified, then we were able to check
    // the mirror, so the mirror data can be updated. Otherwise
    // the previous data need to be kept!
    if (isset($host['mirrorupdated'])) {
        $query = "UPDATE mirrors SET lastchecked = NOW(), has_search = '" . ((int) $host['has_search']) . "', " .
                 "lastupdated = FROM_UNIXTIME(" . $host['mirrorupdated'] . "), " .
                 "phpversion = '" . addslashes($host['phpversion']) . "' " .
                 "WHERE hostname = '" . $host['hostname'] . "'"; 
        $result = mysql_query($query) or sendmessage("unable to update the database: $query: " . mysql_error(), TRUE);
        if ($result) { $mirrorsupdated++; }
    }
}

// DEBUG
sendmessage("$mirrorsupdated number of mirror sites properly updated");

// Debug message sender and die function
function sendmessage($string, $die = FALSE)
{
    @mail("goba@php.net", "Mirror site check status report", $string);
    if ($die) {
        die($string);
    }
}

// Custom error handler
function myhandler($errno, $errstr, $errfile, $errline)
{
    global $host;

    // See if the error is under the error reporting level
    if ($errno & error_reporting()) {
        if (isset($host)) { $hostname = $host['hostname']; }
        else { $hostname = ""; }
        sendmessage("$errno : $errstr : $errfile : $errline : $hostname", TRUE);
    }
}
