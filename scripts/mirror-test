#!/usr/local/bin/php -q
<?php
set_time_limit (0);
/* simple testing system to ping each mirror, and see what state they are in.*/

/* firstly, get some data */

mysql_connect("localhost","nobody","")
  or die("unable to connect to database");
mysql_select_db("php3");

$query = "SELECT maintainer,hostname,id FROM mirrors WHERE mirrortype = 1 AND active";

$result = mysql_query($query)
  or die("unable to get from the database");

for($i=0; $row = mysql_fetch_array($result,MYSQL_ASSOC); $i++) {
	$hosts[$i]['hostname'] = $row['hostname'];
	$hosts[$i]['id'] = $row['id'];
	$hosts[$i]['maintainer'] = $row['maintainer'];
}

/* now this stage takes a long time, and we need to go out of PHP to execute it,
   so we are going to write that info to a file */

$rv = "";
$total = sizeof($hosts);

for($i=0; $i < $total; $i++) {
	
	$rv .= $hosts[$i]['hostname'] . " ";
}

$d = date("U");
$mf = <<< EOF
CCS = $rv
DAT = $d
TMP = /tmp/mirrors/data/
DIR = /tmp/mirrors/
LOG = /tmp/mirrors/log
SAV = /tmp/mold/

all: \${CCS}

\${CCS}: start
\t/home/imajes/bin/wget --verbose --debug --tries=1 --timeout=15 -a $(LOG) http://$@/mirror-info.php -O $(TMP)$@

start: 
\tmkdir -p $(TMP)

clean:
\ttar zcf $(SAV)$(DAT).tar.gz $(DIR)
\trm -rf $(DIR)
#\tkillall wget #isn't currently needed, but some versions of wget suck (use latest cvs). 

EOF;

/* now put this into a makefile, so we can batch process it */
 
@mkdir("/tmp/mirrors", 0777);

$fp = @fopen("/tmp/mirrors/Makefile", "w");
$fw = @fwrite($fp, $mf);
@fclose($fp);

/* execute it, gather data...  */

exec("make -C /tmp/mirrors/ -i -j -k all");

/* now get the info from the files and populate our arrays of data */

for ($i=0; $i < $total; $i++) {
	$file = "/tmp/mirrors/data/" . $hosts[$i]['hostname'];
	$fp = @fopen($file, "r");
	$rv = @fread($fp, 1000);
	
	if(!$fp || strlen($rv) == "0") {
                $hosts[$i]['active'] = false;
        } else {
                $hosts[$i]['active'] = true;
        }
	$info = explode("|", $rv);
	$hosts[$i]['phpversion'] = $info['1'];
	$hosts[$i]['lastupdate'] = $info['2'];
	$hosts[$i]['xtra'] = $info['3'];
	
	if (strlen($info['3']) > 0) {
		$moreinfo = true;
	}
}

for($i=0; $i < $total; $i++) {
	mysql_connect("localhost","nobody","") or die("unable to connect to database");
	mysql_select_db("php3");
	$query = "UPDATE mirrors SET lastchecked=NOW()" . ($hosts[$i]['active'] ? ",lastupdated=FROM_UNIXTIME(".$hosts[$i]['lastupdate']."),phpversion='".addslashes($hosts[$i]['phpversion'])."'" : "") . " WHERE hostname = '" . $hosts[$i]['hostname'] . "'"; 
	$result = mysql_query($query) or die("unable to get from the database");
}
  
/* this cleans what we did. it also kills all the wget sessions that didn't end - however, the make session
goes defunct and loses reporting over the child processes. This should die within a short period of time. */  

exec("make -C /tmp/mirrors/ -k -i clean");
?> 
